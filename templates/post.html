{% extends "base.html" %}


{% block title %}
    {{ post.name }}
{% endblock %}

{% block style %}
    <style type="text/css">
        .co-delete {
            position: inherit;
            float: right;
        }
    </style>
{% endblock %}

{% block script %}
    <script type="text/javascript">
        var appendNewComment = function(commentJson) {
            var c = commentJson;
            var commentHtml = '<p>' + c.user_link + ':  ' + c.content +
                            '   <a href="/comment/delete/' + c.id + '><i class="fa fa-times co-delete"></i></a>' +
                            '</p>';
            var commentList = $('.co-comments');
            console.log('生成的comment html:', commentHtml);
            commentList.append(commentHtml);
        };

        var addComment = function () {
            $('#id-button-write-comment').on('click', function () {
                console.log('点击增加评论');
                var content = $('#id-text-comment-content').val();
                console.log('新评论内容: ', content);
                var post_id = $('#id-post-id').val();
                console.log('评论所属文章: ', post_id);
                var data = {
                    content: content,
                    post_id: post_id,
                };
                postData = JSON.stringify(data);
                console.log('postData: ', postData);
                $.ajax({
                    url: '/comment/add',
                    type: 'POST',
                    data: postData,
                    contentType: 'application/json',
                    success: function (d) {
                        commentJson = JSON.parse(d);
                        console.log('已加评论: ', commentJson);
                        console.log('c.id:',commentJson.id);
                        appendNewComment(commentJson);
                    }
                });
            });
        };

        var __main = function () {
            addComment();
        };

        $(document).ready(function () {
            __main();
        });
    </script>
{% endblock %}

{% block main_content_body %}
    <div class="templatemo-content-container">
    <div class="templatemo-flex-row flex-content-row">
        <div class="templatemo-content-widget white-bg col-2">
            {% if is_admin or post.is_author(current_user) %}
                <a href="/post/delete/{{ post.id }}"><i class="fa fa-times"></i></a>
            {% endif %}

            <div class="square"></div>
            <h2 class="templatemo-inline-block">{{ post.link | safe }}</h2>
            <hr>
            <p>{{ post.author_link | safe }} 发表于: {{ post.time }}</p>
            <p>{{ post.content }}</p>
        </div>
        <div class="co-comments templatemo-content-widget white-bg col-2">
            {% for c in post.comment_list %}
                <p>
                    {{ c.user_link | safe }}: {{ c.content }}
                    {% if is_admin or c.is_author(current_user) %}
                        <a href="/comment/delete/{{ c.id }}"><i class="fa fa-times co-delete"></i></a>
                    {% endif %}
                </p>
            {% endfor %}
        </div>
    </div>
    {% if current_user is not none %}
        <fieldset class="col-lg-12 form-group">
            <label for="id-text-comment-content"></label>
            <textarea class="form-control" id="id-text-comment-content" rows="3" placeholder="添加评论..." name="content"
                      required></textarea>
            <input type="hidden" id="id-post-id" name="post_id" value="{{ post.id }}">
            <button id="id-button-write-comment" class="templatemo-blue-button float-right">评 论</button>
        </fieldset>
    {% endif %}
{% endblock %}